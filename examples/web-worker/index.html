<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ApexRust Web Worker Example</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    h1 { color: #569cd6; }
    h2 { color: #4ec9b0; margin-top: 30px; }
    .panel {
      background: #252526;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
    }
    textarea {
      width: 100%;
      min-height: 150px;
      background: #1e1e1e;
      color: #d4d4d4;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      padding: 10px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      resize: vertical;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px 5px 5px 0;
    }
    button:hover { background: #1177bb; }
    button:disabled { background: #3c3c3c; cursor: not-allowed; }
    pre {
      background: #1e1e1e;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      padding: 10px;
      overflow-x: auto;
      font-size: 13px;
    }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .warning { color: #dcdcaa; }
    #status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    #status.loading { background: #3c3c3c; }
    #status.ready { background: #2d4f2d; }
    #status.error { background: #4f2d2d; }
    select {
      background: #3c3c3c;
      color: #d4d4d4;
      border: 1px solid #3c3c3c;
      padding: 8px;
      border-radius: 4px;
      font-size: 14px;
    }
    label { margin-right: 10px; }
  </style>
</head>
<body>
  <h1>ApexRust Web Worker Demo</h1>

  <div id="status" class="loading">Initializing WASM worker...</div>

  <h2>Parse Apex Code</h2>
  <div class="panel">
    <textarea id="apexInput">public class AccountService {
  public List&lt;Account&gt; getActiveAccounts() {
    return [SELECT Id, Name, Industry FROM Account WHERE IsDeleted = false];
  }

  public Account getAccountById(Id accountId) {
    return [SELECT Id, Name,
            (SELECT Id, FirstName, LastName FROM Contacts)
            FROM Account
            WHERE Id = :accountId];
  }
}</textarea>
    <br><br>
    <button id="parseBtn" disabled>Parse Apex</button>
    <pre id="parseResult"></pre>
  </div>

  <h2>Convert SOQL to SQL</h2>
  <div class="panel">
    <textarea id="soqlInput">SELECT Id, Name, Industry,
       (SELECT Id, FirstName, LastName FROM Contacts)
FROM Account
WHERE Industry = 'Technology'
ORDER BY Name
LIMIT 10</textarea>
    <br><br>
    <label>Dialect:</label>
    <select id="dialect">
      <option value="sqlite">SQLite</option>
      <option value="postgres">PostgreSQL</option>
    </select>
    <button id="convertBtn" disabled>Convert to SQL</button>
    <pre id="convertResult"></pre>
  </div>

  <h2>More Examples</h2>
  <div class="panel">
    <button id="exampleParent" disabled>Parent Relationship</button>
    <button id="exampleBind" disabled>Bind Variables</button>
    <button id="exampleAggregate" disabled>Aggregate Query</button>
    <button id="exampleComplex" disabled>Complex Query</button>
  </div>

  <script type="module">
    // Note: In a real build, these would be bundled properly
    // For this demo, we're showing the structure

    const status = document.getElementById('status');
    const parseBtn = document.getElementById('parseBtn');
    const convertBtn = document.getElementById('convertBtn');
    const apexInput = document.getElementById('apexInput');
    const soqlInput = document.getElementById('soqlInput');
    const dialectSelect = document.getElementById('dialect');
    const parseResult = document.getElementById('parseResult');
    const convertResult = document.getElementById('convertResult');

    // Example queries
    const examples = {
      parent: 'SELECT Id, FirstName, LastName, Account.Name, Account.Industry FROM Contact WHERE Account.Industry != null',
      bind: 'SELECT Id, Name FROM Account WHERE OwnerId = :currentUserId AND CreatedDate > :startDate',
      aggregate: 'SELECT Industry, COUNT(Id) cnt, SUM(AnnualRevenue) total FROM Account GROUP BY Industry HAVING COUNT(Id) > 5',
      complex: `SELECT Id, Name, Industry,
  (SELECT Id, FirstName, LastName, Email FROM Contacts WHERE IsDeleted = false ORDER BY LastName),
  (SELECT Id, Name, Amount, StageName FROM Opportunities WHERE IsClosed = false)
FROM Account
WHERE Industry IN ('Technology', 'Finance', 'Healthcare')
  AND AnnualRevenue > 1000000
ORDER BY Name
LIMIT 50`
    };

    // Schema for conversion
    const schema = {
      objects: [
        {
          name: 'Account',
          fields: [
            { name: 'Id', type: 'Id' },
            { name: 'Name', type: 'String' },
            { name: 'Industry', type: 'Picklist' },
            { name: 'AnnualRevenue', type: 'Currency' },
            { name: 'OwnerId', type: 'Lookup', referenceTo: 'User', relationshipName: 'Owner' },
            { name: 'IsDeleted', type: 'Boolean' },
            { name: 'CreatedDate', type: 'DateTime' },
          ],
          childRelationships: [
            { name: 'Contacts', childObject: 'Contact', field: 'AccountId' },
            { name: 'Opportunities', childObject: 'Opportunity', field: 'AccountId' },
          ]
        },
        {
          name: 'Contact',
          fields: [
            { name: 'Id', type: 'Id' },
            { name: 'FirstName', type: 'String' },
            { name: 'LastName', type: 'String' },
            { name: 'Email', type: 'Email' },
            { name: 'AccountId', type: 'Lookup', referenceTo: 'Account', relationshipName: 'Account' },
            { name: 'IsDeleted', type: 'Boolean' },
          ]
        },
        {
          name: 'Opportunity',
          fields: [
            { name: 'Id', type: 'Id' },
            { name: 'Name', type: 'String' },
            { name: 'Amount', type: 'Currency' },
            { name: 'StageName', type: 'Picklist' },
            { name: 'IsClosed', type: 'Boolean' },
            { name: 'AccountId', type: 'Lookup', referenceTo: 'Account', relationshipName: 'Account' },
          ]
        },
        {
          name: 'User',
          fields: [
            { name: 'Id', type: 'Id' },
            { name: 'Name', type: 'String' },
          ]
        }
      ]
    };

    // Simulated WASM functions (replace with actual imports when built)
    let wasmReady = false;

    async function initWasm() {
      // In a real implementation:
      // import init, { parseApex, convertSoqlToSql, WasmSchema } from './pkg/apexrust.js';
      // await init();

      // Simulating initialization delay
      await new Promise(resolve => setTimeout(resolve, 500));

      status.textContent = 'WASM worker ready! (Demo mode - actual WASM not loaded)';
      status.className = 'ready';
      wasmReady = true;

      // Enable buttons
      parseBtn.disabled = false;
      convertBtn.disabled = false;
      document.querySelectorAll('.panel button').forEach(btn => btn.disabled = false);
    }

    // Demo parse function
    function demoParseApex(source) {
      // Extract SOQL queries using regex (simplified demo)
      const soqlRegex = /\[([^\]]+)\]/g;
      const queries = [];
      let match;
      while ((match = soqlRegex.exec(source)) !== null) {
        if (match[1].toUpperCase().includes('SELECT')) {
          queries.push(match[1].trim());
        }
      }

      return {
        success: true,
        soqlQueries: queries,
        ast: '(AST representation would appear here in actual WASM build)'
      };
    }

    // Demo convert function
    function demoConvertSoql(soql, schema, dialect) {
      // Very simplified conversion for demo
      const tableName = soql.match(/FROM\s+(\w+)/i)?.[1]?.toLowerCase() || 'unknown';
      const placeholder = dialect === 'postgres' ? '$1' : '?1';
      const hasBindVar = soql.includes(':');

      return {
        success: true,
        sql: `-- Converted from SOQL (${dialect} dialect)\n-- Original: ${soql.substring(0, 50)}...\n\nSELECT ... FROM "${tableName}" ...`,
        parameters: hasBindVar ? [{ name: 'p1', placeholder, originalName: 'variable' }] : [],
        warnings: ['Demo mode: actual SQL conversion requires WASM build']
      };
    }

    // Event handlers
    parseBtn.addEventListener('click', () => {
      const result = demoParseApex(apexInput.value);
      parseResult.innerHTML = `<span class="${result.success ? 'success' : 'error'}">
Success: ${result.success}
SOQL Queries Found: ${result.soqlQueries?.length || 0}
${result.soqlQueries?.map((q, i) => `\n[${i + 1}] ${q}`).join('') || ''}
</span>`;
    });

    convertBtn.addEventListener('click', () => {
      const result = demoConvertSoql(soqlInput.value, schema, dialectSelect.value);
      let html = `<span class="${result.success ? 'success' : 'error'}">Success: ${result.success}</span>\n\n`;

      if (result.success) {
        html += `<span class="success">SQL:</span>\n${result.sql}\n`;
        if (result.parameters?.length) {
          html += `\n<span class="warning">Parameters:</span>\n${JSON.stringify(result.parameters, null, 2)}\n`;
        }
        if (result.warnings?.length) {
          html += `\n<span class="warning">Warnings:</span>\n${result.warnings.join('\n')}`;
        }
      } else {
        html += `<span class="error">Error: ${result.error}</span>`;
      }

      convertResult.innerHTML = html;
    });

    // Example buttons
    document.getElementById('exampleParent').addEventListener('click', () => {
      soqlInput.value = examples.parent;
    });
    document.getElementById('exampleBind').addEventListener('click', () => {
      soqlInput.value = examples.bind;
    });
    document.getElementById('exampleAggregate').addEventListener('click', () => {
      soqlInput.value = examples.aggregate;
    });
    document.getElementById('exampleComplex').addEventListener('click', () => {
      soqlInput.value = examples.complex;
    });

    // Initialize
    initWasm().catch(err => {
      status.textContent = `Error: ${err.message}`;
      status.className = 'error';
    });
  </script>
</body>
</html>
